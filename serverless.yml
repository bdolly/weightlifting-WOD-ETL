# Main Serverless Framework configuration file
# This file references modular configuration files for better maintainability

service: invictus-weightlifting-wod-etl

app: invictus-weightlifting-app
org: bromeodolly

# You can pin your service to only deploy with a specific Serverless version
# Check out our docs for more details
# Pinned to V3.x for stability
# IMPORTANT: Always use 'npx serverless' instead of global 'serverless' command
frameworkVersion: '>=3.0.0 <4.0.0'

useDotenv: true

provider:
  name: aws
  region: ${env:AWS_REGION}
  runtime: python3.9
  profile: ${env:AWS_PROFILE, 'serverless-invictus-agent'}
  stage: dev
  iam:
    role:
      statements: ${file(./serverless/iam.yml)}
  environment: ${file(./serverless/environment.yml)}

# you can add packaging information here
package:
  patterns:
    - '!node_modules/**'
    - '!venv/**'
    - '!__pycache__/**'
    - '!test_events/**'
    - '!.serverless/**'
    - '!*.pyc'
    - '!*.pyo'
    - '!*.pyd'
    - '!*.so'
    - '!*.egg-info/**'
    - '!tests/**'
    - '!test/**'
    - '!*.md'
    - '!docs/**'

plugins:
  - serverless-python-requirements
  - serverless-step-functions

custom:
  pythonRequirements:
    dockerizePip: non-linux
    dockerImage: public.ecr.aws/sam/build-python3.9
    fileName: requirements-prod.txt
    slim: true
    strip: true
    zip: true
    layer: true
    # Exclude unnecessary files from packages
    invalidateCaches: false
    pipCmdExtraArgs:
      - --no-cache-dir
    # More aggressive exclusions for pandas/numpy
    slimPatterns:
      - '**/*.pyc'
      - '**/__pycache__/**'
      - '**/tests/**'
      - '**/test/**'
      - '**/*.so.dSYM/**'
      - '**/dist-info/**'
      - '**/site-packages/pandas/tests/**'
      - '**/site-packages/numpy/tests/**'
      - '**/site-packages/pandas/doc/**'
      - '**/site-packages/numpy/doc/**'
      - '**/site-packages/pandas/benchmarks/**'
      - '**/site-packages/numpy/benchmarks/**'
      - '**/site-packages/pandas/.github/**'
      - '**/site-packages/numpy/.github/**'
      - '**/site-packages/pandas/_libs/tslibs/tests/**'
      - '**/site-packages/pandas/_libs/window/**'
      - '**/site-packages/numpy/f2py/tests/**'
      - '**/site-packages/numpy/linalg/tests/**'
      - '**/site-packages/numpy/ma/tests/**'
      - '**/site-packages/numpy/matrixlib/tests/**'
      - '**/site-packages/numpy/polynomial/tests/**'
      - '**/site-packages/numpy/random/tests/**'
      - '**/site-packages/numpy/testing/**'
      - '**/site-packages/numpy/tests/**'
      - '**/site-packages/pandas/tests/**'
      - '**/site-packages/pandas/util/tests/**'
      - '**/site-packages/pandas/_testing/**'
      - '**/site-packages/pandas/io/tests/**'
      - '**/site-packages/pandas/plotting/tests/**'
      - '**/site-packages/pandas/tests/**'
      - '**/*.pyx'
      - '**/*.pxd'
      - '**/*.pxi'
      - '**/*.h'
      - '**/*.c'
      - '**/*.cpp'
      - '**/*.f'
      - '**/*.f90'

functions: ${file(./serverless/functions.yml)}

stepFunctions:
  stateMachines:
    ${file(./SemiStructureInvictusPost_stateMachine.yml)}

resources: ${file(./serverless/resources.yml)}
