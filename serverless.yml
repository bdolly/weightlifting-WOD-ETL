# Main Serverless Framework configuration file
# This file references modular configuration files for better maintainability

service: invictus-weightlifting-wod-etl

app: invictus-weightlifting-app
org: bromeodolly

# You can pin your service to only deploy with a specific Serverless version
# Check out our docs for more details
# Pinned to V3.x for stability
# IMPORTANT: Always use 'npx serverless' instead of global 'serverless' command
frameworkVersion: '>=3.0.0 <4.0.0'

useDotenv: true

provider:
  name: aws
  region: ${env:AWS_REGION}
  runtime: python3.9
  profile: ${env:AWS_PROFILE, 'serverless-invictus-agent'}
  stage: dev
  iam:
    role:
      statements: ${file(./serverless/iam.yml)}
  environment: ${file(./serverless/environment.yml)}

# you can add packaging information here
package:
  patterns:
    - '!node_modules/**'
    - '!venv/**'
    - '!__pycache__/**'
    - '!test_events/**'
    - '!.serverless/**'
    - '!*.pyc'
    - '!*.pyo'
    - '!*.pyd'
    - '!*.so'
    - '!*.egg-info/**'
    - '!tests/**'
    - '!test/**'
    - '!*.md'
    - '!docs/**'

plugins:
  - serverless-python-requirements
  - serverless-step-functions

custom:
  pythonRequirements:
    dockerizePip: non-linux
    dockerImage: public.ecr.aws/sam/build-python3.9
    fileName: requirements-prod.txt
    slim: true
    strip: true
    zip: true
    layer: false
    # Exclude unnecessary files from packages
    invalidateCaches: false
    pipCmdExtraArgs:
      - --no-cache-dir

functions: ${file(./serverless/functions.yml)}

stepFunctions:
  stateMachines:
    ${file(./SemiStructureInvictusPost_stateMachine.yml)}

resources: ${file(./serverless/resources.yml)}
