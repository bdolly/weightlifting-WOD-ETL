service: invictus-weightlifting

app: invictus-weightlifting-app
org: bromeodolly

# You can pin your service to only deploy with a specific Serverless version
# Check out our docs for more details
frameworkVersion: "3"

useDotenv: true

provider:
  name: aws
  region: us-east-1
  runtime: python3.8
  profile: serverless-agent
  stage: dev
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - lambda:InvokeFunction
            - s3:*
            - states:*
          Resource: "*"
        # - Effect: Allow
        #   Action:
        #     - sns:publish
        #   Resource: "*"
        # - Effect: Allow
        #   Action:
        #     - dynamodb:Query
        #     - dynamodb:Scan
        #     - dynamodb:GetItem
        #     - dynamodb:PutItem
        #     - dynamodb:UpdateItem
        #     - dynamodb:DeleteItem
        #   Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.DYNAMODB_TABLE}"
        - Effect: Allow
          Action:
            - logs:*
            - xray:*
          Resource: "*"
        - Effect: Allow
          Action:
            - sqs:*
          Resource: "arn:aws:sqs:${opt:region, self:provider.region}:*:${self:provider.environment.INVICTUS_WEIGHTLIFTING_API_QUEQUE_NAME}"
        - Effect: "Allow"
          Action:
            - "glue:*"
          Resource: "*"
        - Effect: "Allow"
          Action:
            - "athena:*"
          Resource: "*"
        - Effect: "Allow"        
          Action:
            - athena:StartQueryExecution
            - athena:GetQueryExecution
            - athena:GetQueryResults
          Resource: "arn:aws:athena:us-east-1:670325714839:workgroup/primary"
        - Effect: "Allow"
          Action: 
            - glue:*
          Resource: 
            - "arn:aws:glue:us-east-1:670325714839:catalog"
            - "arn:aws:glue:us-east-1:670325714839:database/invictus_tables_dev"
            - "arn:aws:glue:us-east-1:670325714839:table/invictus_tables_dev/raw_posts"
        - Effect: "Allow"
          Action: 
            - s3:PutObject
            - s3:GetObject
            - s3:GetBucketLocation
            - s3:ListBucket
            - s3:AbortMultipartUpload
            - s3:ListMultipartUploadParts
          Resource: 
            - Fn::GetAtt: [AthenaOutputBucket, Arn]
            - Fn::GetAtt: [RawPostsS3Bucket, Arn]
            - !Sub arn:aws:s3:::${RawPostsS3Bucket}/raw/*
            - !Sub arn:aws:s3:::${RawPostsS3Bucket}/raw/

        

  # you can define service wide environment variables here
  environment:
    INVICTUS_BUCKET: invictus-raw-${opt:stage, self:provider.stage}
    INVICTUS_QUERY_BUCKET: invictus-raw-${opt:stage, self:provider.stage}-athena-queries
    INVICTUS_RSS: https://crossfitinvictus.com/category/invictus-athlete-weightlifting/feed/
    INVICTUS_WEIGHTLIFTING_API_CAT_ID: "213"
    INVICTUS_WEIGHTLIFTING_API: https://www.crossfitinvictus.com/wp-json/wp/v2/posts?categories=${self:provider.environment.INVICTUS_WEIGHTLIFTING_API_CAT_ID}
    # DYNAMODB_TABLE: ${self:service}-sessions-${opt:stage, self:provider.stage}
    INVICTUS_WEIGHTLIFTING_API_QUEQUE_NAME: ${self:service}-api-requests-queque-${opt:stage, self:provider.stage}
    TWILLIO_ACCOUNT_PHONE_NUMBER: "+16315282256"	
    TWILLIO_TO_PHONE_NUMBER: "+14012560086"	


# you can add packaging information here
package:
  patterns:
    - '!node_modules/**'
    - '!venv/**'
    - '!__pycache__/**'
    - '!test_events'

plugins:
  - serverless-python-requirements
  - serverless-iam-roles-per-function
  - serverless-step-functions
  - serverless-prune-plugin

custom:
  pythonRequirements:
    dockerizePip: non-linux

functions:
  calc_sqs_items_from_api:
    handler: queque.calc_sqs_items_from_api

  push_item_to_queque:
    handler: queque.push_item_to_queque
    events: 
    # get new posts every Monday at midnight EST (5am GMT)
      - schedule: 
          enabled: true
          rate: cron(0 5 ? * Mon *)
          input: 
            page: 1
            post_per_page: 1
      
  stage_posts_to_s3: 
    handler: handler.trigger_staging_statemachine
    environment:
      statemachine_arn: ${self:resources.Outputs.StagingStateMachine.Value}
    reservedConcurrency: 100
    events:
      - sqs: 
            # arn: !Ref InvictusAPIRequestsSQs.Arn
            arn: arn:aws:sqs:us-east-1:670325714839:invictus-weightlifting-api-requests-queque-dev
            batchSize: 1
            maximumBatchingWindow: 60
            functionResponseType: ReportBatchItemFailures

  dump_post_to_bucket:
    handler: handler.dump_post_to_bucket
   
  get_invictus_post:
    handler: handler.GET_invictus_post
    timeout: 10 # optional, in seconds, default is 6
    environment:
      aws_region: ${self:provider.region}
      stage: ${self:provider.stage}
    iamRoleStatements:
      - Effect: "Allow"        
        Action:
          - secretsmanager:GetResourcePolicy
          - secretsmanager:GetSecretValue
          - secretsmanager:DescribeSecret
          - secretsmanager:ListSecretVersionIds
        Resource: "arn:aws:secretsmanager:us-east-1:670325714839:secret:dev/InvictusServices/wp-api-alGCzG"
      - Effect: "Allow"
        Action: "secretsmanager:ListSecrets"
        Resource: "*"

  strip_post_html:
    handler: handler.strip_post_html

  group_post_by_day:
    handler: transforms.group_post_content_by_day

  # segment_days:
    # handler: transforms.segment_days

  # sessions_to_date_records:
  #   handler: transforms.sessions_to_json_records_by_day
    
  # clean_session_records:
  #   handler: handler.clean_sessions_df_records
   
  # save_sessions_to_bucket:
  #   handler: handler.save_sessions_to_bucket

  query_raw_workout_bucket: 
    handler: handler.query_for_workout_this_week
    timeout: 30 # optional, in seconds, default is 6
    environment:
      aws_region: ${self:provider.region}
      stage: ${self:provider.stage}
      athena_output_bucket: !Ref AthenaOutputBucket
      athena_db: !Ref GlueDatabase
   
  send_sms:
    handler: handler.send_sms
    timeout: 10 # optional, in seconds, default is 6
    environment:
      aws_region: ${self:provider.region}
      from_phone_num: ${self:provider.environment.TWILLIO_ACCOUNT_PHONE_NUMBER}
      to_phone_num: ${self:provider.environment.TWILLIO_TO_PHONE_NUMBER}
    iamRoleStatements:
      - Effect: "Allow"        
        Action:
          - secretsmanager:GetResourcePolicy
          - secretsmanager:GetSecretValue
          - secretsmanager:DescribeSecret
          - secretsmanager:ListSecretVersionIds
        Resource: "arn:aws:secretsmanager:us-east-1:670325714839:secret:dev/Twillio/api-gT5wiw"
      - Effect: "Allow"
        Action: "secretsmanager:ListSecrets"
        Resource: "*"

   
stepFunctions:
  stateMachines:
    # SemiStructureInvictusPost: ${file(./SemiStructureInvictusPost_stateMachine.yml)}
    ScrapeInvictusPostsStateMachine: ${file(./ScrapeInvictusPostsStateMachine.yml)}
    InvictusPostsStagingStateMachine: ${file(./InvictusPostsStagingStateMachine.yml)}
    WODNotificationStateMachine: ${file(./WODNotificationStateMachine.yml)}
    
resources:
  Outputs:
    StagingStateMachine:
      Description: The ARN of the provisioning state machine
      Value:
        Ref: InvictusPostsStagingStateMachine
    AthenaOutputBucket:
      Value: !Ref AthenaOutputBucket
    RawPostsS3Bucket:
      Value: !Ref RawPostsS3Bucket
    GlueDatabase: 
      Value: !Ref GlueDatabase

  Resources:
    InvictusAPIRequestsSQS:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:provider.environment.INVICTUS_WEIGHTLIFTING_API_QUEQUE_NAME}
        VisibilityTimeout: 30
    # WorkoutPostsTable:
    #   Type: AWS::DynamoDB::Table
    #   Properties:
    #     TableName: ${self:provider.environment.DYNAMODB_TABLE}
    #     AttributeDefinitions:
    #       - AttributeName: date
    #         AttributeType: S
    #       - AttributeName: session
    #         AttributeType: S
    #     KeySchema:
    #       - AttributeName: date
    #         KeyType: HASH
    #       - AttributeName: session
    #         KeyType: RANGE
    #     ProvisionedThroughput:
    #       ReadCapacityUnits: 1
    #       WriteCapacityUnits: 1
    # SemiStructuedPostStateMachineTrigger:
    #   Type: AWS::Events::Rule
    #   Properties:
    #     Name: SemiStructureInvictusPost_trigger
    #     State: DISABLED
    #     Description: trigger the SemiStructureInvictusPost state machine
    #     ScheduleExpression: rate(10 minutes)
    #     Targets:
    #       - Arn:
    #           Fn::GetAtt: [SemiStructureInvictusPostStateMachine, Arn]
    #         Id: SemiStructure_InvictusPost_StateMachine
    #         RoleArn: arn:aws:iam::670325714839:role/service-role/AWS_Events_Invoke_Step_Functions_1766034610
    SemiStructuedPostStateMachineRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: SemiStructuedPostStateMachineRole
        # Path: /path_of_state_machine_roles/
        AssumeRolePolicyDocument:
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - states.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: statePolicy
            PolicyDocument:
              Version: "2012-10-17"
              Statement: ${self:provider.iam.role.statements}
    RawPostsS3Bucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:provider.environment.INVICTUS_BUCKET}

    GlueDatabase:
      Type: AWS::Glue::Database
      Properties:
        CatalogId: !Ref AWS::AccountId
        DatabaseInput:
          Name: invictus_tables_${self:provider.stage}
    
    RawPostsTable:
      Type: AWS::Glue::Table
      Properties:
        CatalogId: !Ref AWS::AccountId
        DatabaseName: !Ref GlueDatabase
        TableInput:
          Name: raw_posts
          TableType: EXTERNAL_TABLE
          Parameters:
            projection.enabled: true
            projection.date_partition.type: date
            projection.date_partition.range: '2017/09/23,NOW'
            projection.date_partition.format: 'yyyy/MM/dd'
            projection.date_partition.interval: 1
            projection.date_partition.interval.unit: 'DAYS'
            storage.location.template: !Join [ '', [ 's3://', !Ref RawPostsS3Bucket, '/raw/$', '{date_partition}' ] ]
          PartitionKeys:
            - Name: date_partition
              Type: string
          StorageDescriptor:
            Location: !Sub s3://${RawPostsS3Bucket}/raw/
            InputFormat: org.apache.hadoop.mapred.TextInputFormat
            OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
            SerdeInfo:
              SerializationLibrary: org.apache.hive.hcatalog.data.JsonSerDe
            Columns:
              - Name: id
                Type: int
              - Name: date
                Type: string
              - Name: title 
                Type: struct<rendered:string>
              - Name: content 
                Type: struct<rendered:string>
              - Name: categories 
                Type: array<int>                                          

    AthenaOutputBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:provider.environment.INVICTUS_QUERY_BUCKET}
    
    WODNotificationStateMachineRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: WODNotificationStateMachineRole
        # Path: /path_of_state_machine_roles/
        AssumeRolePolicyDocument:
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - states.amazonaws.com
              Action:
                - sts:AssumeRole
        Policies:
          - PolicyName: statePolicy
            PolicyDocument:
              Version: "2012-10-17"
              Statement: ${self:provider.iam.role.statements}