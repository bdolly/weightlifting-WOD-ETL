# S3 Permissions - Scoped to specific bucket and paths
- Effect: Allow
  Action:
    - s3:GetObject
    - s3:PutObject
    - s3:DeleteObject
    - s3:ListBucket
  Resource:
    - "arn:aws:s3:::${self:provider.environment.INVICTUS_BUCKET}"
    - "arn:aws:s3:::${self:provider.environment.INVICTUS_BUCKET}/*"
# DynamoDB Permissions - Scoped to specific tables
- Effect: Allow
  Action:
    - dynamodb:Query
    - dynamodb:Scan
    - dynamodb:GetItem
    - dynamodb:PutItem
    - dynamodb:UpdateItem
    - dynamodb:DeleteItem
  Resource:
    - "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.DYNAMODB_TABLE}"
    - "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.IDEMPOTENCY_TABLE}"
# CloudWatch Logs - Scoped to this service's log groups
- Effect: Allow
  Action:
    - logs:CreateLogGroup
    - logs:CreateLogStream
    - logs:PutLogEvents
    - logs:DescribeLogStreams
  Resource:
    - "arn:aws:logs:${opt:region, self:provider.region}:*:log-group:/aws/lambda/${self:service}-*"
    - "arn:aws:logs:${opt:region, self:provider.region}:*:log-group:/aws/lambda/${self:service}-*:*"
# X-Ray Permissions - Write-only for this service
- Effect: Allow
  Action:
    - xray:PutTraceSegments
    - xray:PutTelemetryRecords
  Resource: "*"
# SQS Permissions - For Dead Letter Queue
- Effect: Allow
  Action:
    - sqs:SendMessage
  Resource:
    Fn::GetAtt:
      - DeadLetterQueue
      - Arn
# Secrets Manager Permissions - For WordPress credentials
- Effect: Allow
  Action:
    - secretsmanager:GetSecretValue
  Resource:
    - "arn:aws:secretsmanager:${opt:region, self:provider.region}:*:secret:${self:provider.environment.INVICTUS_SECRET_NAME}*"
# KMS Permissions - For Secrets Manager decryption
- Effect: Allow
  Action:
    - kms:Decrypt
  Resource: "*"
  Condition:
    StringEquals:
      kms:ViaService:
        - "secretsmanager.${opt:region, self:provider.region}.amazonaws.com"

